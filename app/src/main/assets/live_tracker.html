<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Live Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .info-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
        }
        .status-live {
            color: #ef4444;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .pulse {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .status-ended {
            color: #6b7280;
            font-weight: bold;
            font-size: 14px;
        }
        .time {
            color: #6b7280;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="info-box">
        <div class="status-live" id="status">
            <span class="pulse"></span>
            Live Tracking
        </div>
        <div class="time" id="lastUpdate">Connecting...</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('id');

        if (!shareId) {
            document.body.innerHTML = '<div style="padding:20px;text-align:center;"><h2>Invalid tracking link</h2><p>Please check your link and try again.</p></div>';
            throw new Error('No shareId provided');
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAu_zOKuB4-pU_iRFEjpHeNLLQMMmz6K30",
            authDomain: "safetyapp-2042f.firebaseapp.com",
            databaseURL: "https://safetyapp-2042f-default-rtdb.firebaseio.com",
            projectId: "safetyapp-2042f",
            storageBucket: "safetyapp-2042f.firebasestorage.app",
            messagingSenderId: "551439184857",
            appId: "1:551439184857:android:46ee289047761b1d895fc8"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let map;
        let currentMarker;
        let pathCoordinates = [];
        let pathLine;

        // Red marker icon for current location
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        function initMap(lat, lng) {
            // Initialize map with OpenStreetMap tiles
            map = L.map('map').setView([lat, lng], 17);

            // Add OpenStreetMap tiles (looks like Google Maps)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Create red marker for current location
            currentMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
            currentMarker.bindPopup('<b>Current Location</b>').openPopup();

            // Create green path line for movement
            pathLine = L.polyline(pathCoordinates, {
                color: '#10b981',
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);
        }

        // Listen for location updates from Firebase
        const locationRef = database.ref('LiveLocations/' + shareId + '/currentLocation');
        let hasReceivedLocation = false;
        let connectionTimeout;

        // Set a timeout to show error if no location received within 30 seconds
        connectionTimeout = setTimeout(() => {
            if (!hasReceivedLocation) {
                document.getElementById('lastUpdate').textContent =
                    'Waiting for location data... Please ensure location sharing is active on the device.';
                document.getElementById('lastUpdate').style.color = '#f59e0b';
            }
        }, 30000);

        locationRef.on('value', (snapshot) => {
            const data = snapshot.val();

            if (data && data.latitude && data.longitude) {
                hasReceivedLocation = true;
                clearTimeout(connectionTimeout);

                const lat = data.latitude;
                const lng = data.longitude;
                const timestamp = data.timestamp;

                // Initialize map on first location
                if (!map) {
                    initMap(lat, lng);
                }

                const newLatLng = [lat, lng];

                // Update red marker to new position
                currentMarker.setLatLng(newLatLng);
                currentMarker.bindPopup('<b>Current Location</b><br>Updated: ' + new Date(timestamp).toLocaleTimeString()).openPopup();

                // Add to green path
                pathCoordinates.push(newLatLng);
                pathLine.setLatLngs(pathCoordinates);

                // Center map on current location
                map.panTo(newLatLng);

                // Update timestamp with normal color
                const date = new Date(timestamp);
                document.getElementById('lastUpdate').textContent =
                    'Updated: ' + date.toLocaleTimeString();
                document.getElementById('lastUpdate').style.color = '#6b7280';
            }
        });

        // Check if tracking session exists and is active
        const sessionRef = database.ref('LiveLocations/' + shareId);
        let sessionCheckTimeout;

        // Check if session exists within 10 seconds
        sessionCheckTimeout = setTimeout(() => {
            if (!hasReceivedLocation) {
                sessionRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        document.getElementById('lastUpdate').textContent =
                            'Tracking session not found. The link may be invalid or expired.';
                        document.getElementById('lastUpdate').style.color = '#ef4444';
                        document.getElementById('status').innerHTML = '<span style="color:#ef4444">⚫ Session Not Found</span>';
                        document.getElementById('status').className = 'status-ended';
                    }
                });
            }
        }, 10000);

        sessionRef.child('isActive').on('value', (snapshot) => {
            if (snapshot.val() === false) {
                clearTimeout(connectionTimeout);
                clearTimeout(sessionCheckTimeout);
                document.getElementById('status').innerHTML = '<span style="color:#6b7280">⚫ Tracking Ended</span>';
                document.getElementById('status').className = 'status-ended';
                document.getElementById('lastUpdate').textContent = 'Location sharing has ended';
            } else if (snapshot.val() === true && hasReceivedLocation) {
                clearTimeout(sessionCheckTimeout);
            }
        });

        // Handle connection errors
        locationRef.on('error', (error) => {
            console.error('Firebase error:', error);
            document.getElementById('lastUpdate').textContent = 'Connection error. Please check your internet connection.';
            document.getElementById('lastUpdate').style.color = '#ef4444';
        });
    </script>
</body>
</html>
